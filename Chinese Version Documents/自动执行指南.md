# 🤖 自动执行指南 - 工作原理解析

**目的**: 解释 Prefect Cloud 如何自动执行工作流  
**日期**: 2025年12月  
**核心问题**: "Prefect 会自动执行吗？即使我的电脑关机也能执行吗？"

---

## ✅ 快速答案

**是的，Prefect Cloud 会自动在指定时间执行工作流。** ✅

但是有**一个关键要求**：你的 Worker 必须在执行时间到达时在线。

---

## 🏗️ 架构：工作原理

### 完整流程

```
PREFECT CLOUD (云服务 - 运行在 Prefect 的服务器上)
    ├─ 调度器 (永远运行，从不停止)
    │   └─ 监控所有时间表
    │       └─ 在 15 号 09:00：创建 Flow Run "currency-acquisition"
    │
    ├─ Flow Run 队列 (存放待执行的任务)
    │   └─ 等待 Worker 接收任务
    │
    └─ 运行日志存储 (保存所有执行历史)
         └─ 记录每次执行结果

              ↓ (网络连接)

你的电脑 (执行时间必须在线)
    ├─ Python 环境
    ├─ Worker 进程 (定期轮询 Prefect Cloud 是否有任务)
    │   └─ "有任务给我吗？" (每 3 秒问一次)
    │       └─ 如果有：接受并执行
    │       └─ 如果没有：继续等待
    │
    ├─ 工作流代码 (currency_acquisition_flow.py 等)
    └─ 存储 (结果、CSV 文件、日志)
```

---

## ⏰ 时间线：执行时会发生什么

### 示例：2025年1月15日 09:00 (Asia/Shanghai 时区)

**场景 A：你的电脑在线** ✅

```
09:00:00 - Prefect Cloud 调度器触发
           
           Cloud 说："是时候执行 currency-acquisition 了！"
           ↓
           Cloud 创建 Flow Run，ID：12345abc
           ↓
           Cloud 把它放入 Work Pool 队列："Yichen_Test"
           ↓
09:00:02 - 你的 Worker 轮询 Cloud："有任务吗？"
           ↓
           Cloud 回复："有！运行 12345abc"
           ↓
09:00:03 - 你的 Worker 接受这个任务
           ↓
           工作流在你的电脑上执行
           ↓
           currency_acquisition_flow() 开始
           ↓
09:00:45 - 汇率获取完成
           ↓
           结果保存到：data/exchange_rates_2025_01.csv
           ↓
           Cloud 记录：成功 ✅
```

**场景 B：你的电脑关机** ❌

```
09:00:00 - Prefect Cloud 调度器触发
           
           Cloud 说："是时候执行 currency-acquisition 了！"
           ↓
           Cloud 创建 Flow Run，ID：12345abc
           ↓
           Cloud 把它放入 Work Pool 队列："Yichen_Test"
           ↓
09:00:02 - Cloud 等待 Worker 轮询
           
           但是...你的电脑关机了
           ↓
           Worker 无法连接
           ↓
09:05:00 - Cloud 继续等待...
           ↓
           Flow Run 状态：已排队（SCHEDULED），未执行
           ↓
           Cloud 记录：没有可用的 Worker ⚠️
```

---

## 🔑 关键要求：Worker 必须在线

### 什么是 Worker?

**Worker** 是一个程序，用来：
1. 运行在你的电脑上（或服务器上）
2. 连接到 Prefect Cloud
3. 定期询问："你有任务要我执行吗？"
4. 当有任务时执行工作流

### 启动 Worker

```powershell
prefect worker start --pool Yichen_Test
```

**这个命令的作用**：
```
1. 连接到 Prefect Cloud (使用你的 API 密钥)
2. 识别你的 Work Pool："Yichen_Test"
3. 每 3 秒轮询一次 Cloud："有新任务吗？"
4. 等待 Flow Run 进入队列
5. 当有新任务时，执行它
6. 将结果上传回 Cloud
```

**运行时的输出**：
```
Worker 'Yichen_Test' started successfully
Listening for flow runs on 'Yichen_Test' pool...
[Waiting for runs...]
[Waiting for runs...]
[Run 12345abc received!]
[Executing currency_acquisition_flow...]
[Run complete! Status: SUCCESS]
[Waiting for runs...]
```

---

## 📋 推荐的设置方案

### 方案 1：电脑始终开机（最安全）

**设置**：让电脑 24/7 运行，Worker 持续轮询

**优点**：
- ✅ 100% 保证捕获所有定时执行
- ✅ 设置简单，容易维护
- ✅ 每个月都能可靠执行

**缺点**：
- ❌ 电脑一直开机（费电）
- ❌ 硬件磨损

**怎样做**：
```
1. 让电脑一直开着
2. 运行：prefect worker start --pool Yichen_Test
3. 保持终端窗口打开
4. 不要关闭它
```

---

### 方案 2：执行时间到时再开机（推荐）

**设置**：在执行前 5 分钟启动电脑并启动 Worker

**优点**：
- ✅ 省电（电脑大部分时间关机）
- ✅ 电脑只在需要时开机
- ✅ 如果记得启动 Worker，就很可靠

**缺点**：
- ❌ 需要手动执行（启动 Worker）
- ❌ 可能忘记在执行日期启动
- ❌ 需要手动唤醒电脑

**怎样做**：
```
1. 设置手机提醒，在每个执行日期的 08:55 提醒
   执行日期：每月 15 号、25 号、28-31 号
   
2. 当提醒响起：
   - 打开电脑
   - 等待启动（1-2 分钟）
   - 打开 PowerShell
   - 运行：prefect worker start --pool Yichen_Test
   - 保持终端打开到 10:15（确保覆盖所有 3 个工作流）
   
3. 10:15 之后：
   - 关闭终端
   - 关闭电脑
```

**每月提醒日期**：
```
1 月：15 号、25 号、28-31 号（共 6 次）
2 月：15 号、25 号、28 号（共 3 次）
3 月：15 号、25 号、28-31 号（共 6 次）
...（其他月份类似）

全年提醒总数：约 22 次/月 × 12 月 = ~264 次提醒
每次耗时：约 20-25 分钟
```

---

### 方案 3：专业服务器（企业级）

**设置**：在专业服务器/VPS 上运行 Worker，永远开机

**优点**：
- ✅ 100% 可用性
- ✅ 不需要管理个人电脑
- ✅ 专业基础设施
- ✅ 可以运行多个 Worker

**缺点**：
- ❌ 需要花钱（VPS 托管费）
- ❌ 设置更复杂
- ❌ 对于月度执行来说有点浪费

**成本**：约 5-20 美元/月的小型 VPS

**怎样做**：
```
1. 租一个 VPS（DigitalOcean、AWS 等）
2. 安装 Python 和 Prefect
3. 在 VPS 上启动 Worker
4. 让它永远运行
```

---

## 🚨 如果 Worker 离线会怎样？

### Flow Run 状态变化过程

```
09:00:00 SCHEDULED  ← Cloud 已排期这个任务
         ↓
09:00:05 QUEUED     ← 任务在队列中等待 Worker
         ↓
09:05:00 仍然 QUEUED
         ↓
09:30:00 仍然 QUEUED
         ↓
?? 如果 Worker 上线了：RUNNING → COMPLETED ✅
?? 如果 Worker 从未上线：永远保持 QUEUED ⏳
```

### 可以稍后重试吗？

**可以！** 有以下选项：

1. **稍后手动触发**：
   ```powershell
   prefect deployment run currency-acquisition
   # 立即执行，不是按计划执行
   ```

2. **在 Cloud UI 中手动操作**：
   - 打开 Cloud UI
   - 找到排队的任务
   - 点击"重试"或"重新运行"
   - 如果 Worker 现在在线，立即执行

3. **等到下个月**：
   - 定时任务是按月执行的
   - 如果错过 1 月 15 号，下个运行是 1 月 25 号
   - 确保到那时 Worker 已启动

---

## 🔄 Cloud 调度器 vs 本地调度器

### 关键区别

**你可能认为**：
```
"我的电脑有一个时间表（比如 Windows 任务计划）"
"所以当电脑关机时，时间表会暂停"
```

**Prefect 的实际工作方式**：
```
"Prefect Cloud（不是你的电脑）管理时间表"
"你的电脑只需在执行时在线"
"Cloud 永远不会忘记触发 - 它一直在运行"
```

### 可视化对比

```
传统调度器（Windows 任务计划）：
┌─────────────────────────┐
│ 你的电脑                │
│ ├─ 时间表：09:00        │
│ ├─ 任务：currency_acq   │
│ └─ 状态：不活跃         │ ← 电脑关机 = 时间表暂停
└─────────────────────────┘

Prefect Cloud 调度器：
┌──────────────────────────────────┐
│ Prefect Cloud（始终运行）        │
│ ├─ 时间表：每月 15 号 09:00      │
│ ├─ 状态：活跃 ✅                 │ ← 永远在监控
│ └─ 等待：Worker 上线             │
└──────────────────────────────────┘
         ↓
┌─────────────────────────┐
│ 你的电脑                │
│ ├─ Worker：离线         │ ← 可以关机（直到 09:00）
│ ├─ Worker：在线         │ ← 必须在 09:00 时在线
│ └─ Worker：离线         │ ← 可以关机（10:15 之后）
└─────────────────────────┘
```

---

## 📊 Work Pool 类型解释

你的 Work Pool 是：**prefect:managed**

### "prefect:managed" 是什么意思？

```
Work Pool 类型：prefect:managed

执行地点：❌ 不在 Prefect Cloud
执行地点：✅ 在你的 Worker 机器上

架构：
  Cloud 创建 run
    ↓
  发送 run 到 Work Pool "Yichen_Test"
    ↓
  你的 Worker 接收它
    ↓
  你的电脑执行这个工作流
```

### 其他 Work Pool 类型（供参考）

| 类型 | 执行地点 | 需要 Worker | 电脑关机时 |
|------|---------|-----------|----------|
| prefect:managed | 你的机器 | 是 | ❌ 无法执行 |
| prefect:agent | 你的机器 | 是 | ❌ 无法执行 |
| prefect:cloud-run | Google Cloud | 否 | ✅ 自动执行 |
| prefect:ecs | AWS ECS | 否 | ✅ 自动执行 |
| prefect:kubernetes | K8s 集群 | 否 | ✅ 自动执行 |

**结论**：使用 prefect:managed 时，你**必须**在执行时有 Worker 在线。

---

## ✅ 检查清单：确保自动执行

### 每月检查（执行日期前）

- [ ] Worker 可以无错误地启动
  ```powershell
  prefect worker start --pool Yichen_Test
  # 应该显示："Worker started successfully"
  ```

- [ ] 网络连接正常
  ```powershell
  Test-NetConnection app.prefect.cloud
  # 应该显示：TcpTestSucceeded: True
  ```

- [ ] 时间表在 Cloud 中仍然启用
  ```
  Cloud UI → Deployments → [Flow] → Schedules
  检查：3 个时间表都标记为"启用"
  ```

### 每个执行日期前

**方案 A：设置提醒（推荐）**
- [ ] 日历提醒设置为 08:55
- [ ] 计划提前 5 分钟启动 Worker
- [ ] 保持终端打开 20 分钟

**方案 B：保持电脑开机**
- [ ] 电脑 24/7 运行
- [ ] Worker 进程永远运行
- [ ] 终端窗口可见

### 执行日期的验证

- [ ] Worker 在 09:00 前启动
- [ ] 监控 Cloud UI 中的执行情况
- [ ] 验证所有 3 个工作流完成
- [ ] 检查 CSV 文件是否创建

---

## 🔍 故障排除：为什么没有执行？

### 问题 1："Run 仍在 QUEUED"

**原因**：执行时间到达时 Worker 离线

**检查**：
```powershell
# 在 09:00 时 Worker 是否在运行？
# 检查你的终端历史
# 查找："Worker started successfully"
```

**解决**：
```powershell
# 现在启动 Worker
prefect worker start --pool Yichen_Test

# 手动触发工作流（立即执行）
prefect deployment run currency-acquisition

# 下个月：记得在 08:55 启动 Worker
```

---

### 问题 2："历史记录中没有运行"

**原因**：时间表可能被禁用或 Cloud 问题

**在 Cloud UI 中检查**：
```
Deployments → currency-acquisition → Schedules

查看：
✓ 时间表是否存在
✓ 状态是否为"启用"（绿色）
✓ 下次运行日期是否正确
```

**解决**：
```
1. 检查时间表是否启用
2. 如果禁用，启用它
3. 手动触发：prefect deployment run currency-acquisition
```

---

### 问题 3："Worker 崩溃或断开连接"

**症状**：
- Worker 启动但显示错误
- 终端显示："Connection lost"

**检查**：
```powershell
# 能否连接到 Cloud？
Test-NetConnection app.prefect.cloud -Port 443

# API 密钥是否有效？
prefect config view | findstr "PREFECT_API_KEY"
```

**解决**：
```powershell
# 重新登录 Cloud
prefect cloud login

# 重启 Worker
prefect worker start --pool Yichen_Test
```

---

## 📞 什么时候需要手动操作

你需要手动启动 Worker，如果：

- [ ] 执行时间时电脑关机了
- [ ] Worker 崩溃或断开连接
- [ ] 你想立即测试工作流
- [ ] 你需要按不同的时间表运行工作流

**手动触发命令**：
```powershell
prefect deployment run currency-acquisition

# 立即运行，不管时间表
# 用于测试或补救执行
```

---

## 🎯 最佳实践建议

### 对于你的情况（月度执行）

**推荐设置**：方案 2（执行时间到时再开机）

**步骤**：

1. **设置每月提醒**（使用手机日历）
   ```
   1 月：15、25、28、29、30、31 号 @ 08:55
   2 月：15、25、28 号 @ 08:55（闰年为 29 号）
   ...（所有月份）
   
   全年总提醒数：~22 次/月
   ```

2. **当提醒响起**：
   ```powershell
   # 步骤 1：打开电脑
   # 步骤 2：等待 1-2 分钟启动
   # 步骤 3：打开 PowerShell
   # 步骤 4：进入项目目录
   cd C:\Users\yli\Desktop\Prefect_Project
   
   # 步骤 5：启动 Worker
   prefect worker start --pool Yichen_Test
   
   # 步骤 6：观察输出
   # 你会看到："Worker started successfully"
   # 然后：在 09:00-10:00："[Run 12345 received!]"
   # 然后：" [Run complete!]"
   
   # 步骤 7：10:15 之后，关闭终端并关机
   ```

3. **Worker 启动后无需交互**
   - Worker 自动接受并执行 run
   - 所有 3 个工作流按序执行
   - 结果自动上传到 Cloud

---

## 📈 月度执行日期表

**每个月的执行日期**：
```
每个月的：15 号、25 号、28、29、30、31 号

按月份的日期（2025 年）：
1 月：15、25、28、29、30、31（6 天）
2 月：15、25、28（3 天，2025 年只有 28 天）
3 月：15、25、28、29、30、31（6 天）
4 月：15、25、28、29、30（5 天，没有 31）
5 月：15、25、28、29、30、31（6 天）
6 月：15、25、28、29、30（5 天，没有 31）
7 月：15、25、28、29、30、31（6 天）
8 月：15、25、28、29、30、31（6 天）
9 月：15、25、28、29、30（5 天，没有 31）
10 月：15、25、28、29、30、31（6 天）
11 月：15、25、28、29、30（5 天，没有 31）
12 月：15、25、28、29、30、31（6 天）

全年提醒总数：~264 个（~22 个/月）
每个提醒耗时：~20 分钟
全年总耗时：~88 小时（~7 小时/月）
```

---

## 🎊 总结

**要保证自动执行**：

✅ **Prefect Cloud 处理调度**（始终运行）
✅ **你的 Worker 执行工作流**（执行时必须在线）
✅ **推荐：在每个执行日期前 5 分钟启动 Worker**
✅ **成本：全年约 22 个提醒，每次 ~20 分钟**
✅ **可靠性：如果你按时启动 Worker，100% 可靠**

**你的电脑大部分时间可以关机。只需在每个执行日期开机约 20 分钟。**

---

**更多问题？** 参考 PRODUCTION_DEPLOYMENT_CHECKLIST_EN.md 获取详细的监控程序。
